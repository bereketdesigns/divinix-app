---
import jsonwebtoken from 'jsonwebtoken';

// This is the main entry point for the app (e.g., your-app.vercel.app/)

const JWT_SECRET = import.meta.env.JWT_SECRET;
const token = Astro.cookies.get('auth_token')?.value;
let isLoggedIn = false;

if (token && JWT_SECRET) {
  try {
    // Verify the token on the server to ensure it's valid
    jsonwebtoken.verify(token, JWT_SECRET);
    isLoggedIn = true;
  } catch (error) {
    // Token is invalid (expired or tampered with), treat as logged out
    isLoggedIn = false;
    // Delete the bad cookie
    Astro.cookies.delete('auth_token', { path: '/' });
  }
}

// Redirect based on the login state
if (isLoggedIn) {
  // If the user has a valid session, send them directly to their edit page.
  return Astro.redirect('/edit');
} else {
  // If the user is not logged in, send them to the public discovery page.
  return Astro.redirect('/discover');
}
---
<!-- This page has no HTML content as it only ever redirects the user. -->